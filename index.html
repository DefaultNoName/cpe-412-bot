<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ESP32 Joystick + Line Trace</title>
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            margin: 0;
            padding: 12px;
            background: #f6f7fb;
            color: #111
        }

        h1 {
            font-size: 18px;
            margin: 0 0 8px 0
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px
        }

        .panel {
            background: #fff;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(10, 10, 20, 0.04)
        }

        #joystickWrap {
            width: 260px;
            height: 260px;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto
        }

        #pad {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: linear-gradient(180deg, #eee, #ddd);
            position: relative;
        }

        #knob {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #2b90ff;
            transform: translate(-50%, -50%);
            position: absolute;
            left: 50%;
            top: 50%;
            box-shadow: 0 6px 18px rgba(43, 144, 255, 0.25);
            cursor: grab;
        }

        label {
            font-size: 13px;
            color: #555
        }

        input[type=range] {
            width: 160px
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            background: #2b90ff;
            color: white;
            font-weight: 600
        }

        #status {
            font-size: 13px;
            color: #333
        }

        #vals {
            font-family: monospace;
            color: #222;
            font-size: 13px
        }

        .small {
            font-size: 12px;
            color: #666
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .toggle button {
            background: #e0e0e0;
            color: #111;
        }

        .toggle button.active {
            background: #2b90ff;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="panel">
        <div class="row">
            <div>
                <div id="joystickWrap">
                    <div id="pad">
                        <div id="knob" aria-hidden="true"></div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:8px" class="small">Drag the knob â€” vertical = forward/back,
                    horizontal = turn</div>
            </div>
            <div style="flex:1; min-width:200px;">
                <div style="margin-bottom:8px">
                    <label>WebSocket URL</label><br />
                    <input id="wsUrl" type="text" value="ws://192.168.120.1/ws"
                        style="width:100%; padding:6px; box-sizing:border-box" />
                </div>
                <div class="row">
                    <button id="connectBtn">Connect</button>
                    <div id="status" class="panel small" style="padding:8px">disconnected</div>
                </div>

                <div style="margin-top:12px">
                    <label>Max speed: <span id="maxSpeedLbl">4095</span></label><br />
                    <input id="maxSpeed" type="range" min="255" max="4095" step="1" value="4095">
                </div>

                <div style="margin-top:8px">
                    <label>Deadzone (%) : <span id="deadLbl">6</span>%</label><br />
                    <input id="deadzone" type="range" min="0" max="30" step="1" value="6">
                </div>

                <div style="margin-top:8px">
                    <label>Send rate (ms):</label><br />
                    <input id="sendRate" type="range" min="20" max="500" step="10" value="80"><span class="small"> <span
                            id="rateLbl">80</span> ms</span>
                </div>

                <!-- NEW: Line-tracing toggle -->
                <div style="margin-top:12px" class="toggle">
                    <label>Line-tracing:</label>
                    <button id="lineToggle">OFF</button>
                    <div class="small" id="lineStatus">mode: manual</div>
                </div>

            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px">
            <div id="vals" class="panel" style="padding:8px">L:0&nbsp;&nbsp;R:0</div>
            <div class="small">Format: <code>"L,R\n"</code> &nbsp; Toggle format: <code>"MODE:LINE:1"</code> or
                <code>"MODE:LINE:0"</code>
            </div>
        </div>
    </div>

    <script>
        (() => {
            const knob = document.getElementById('knob');
            const pad = document.getElementById('pad');
            const wsUrlInput = document.getElementById('wsUrl');
            const connectBtn = document.getElementById('connectBtn');
            const statusDiv = document.getElementById('status');
            const maxSpeedInput = document.getElementById('maxSpeed');
            const maxSpeedLbl = document.getElementById('maxSpeedLbl');
            const deadInput = document.getElementById('deadzone');
            const deadLbl = document.getElementById('deadLbl');
            const sendRateInput = document.getElementById('sendRate');
            const rateLbl = document.getElementById('rateLbl');
            const vals = document.getElementById('vals');

            const lineToggleBtn = document.getElementById('lineToggle');
            const lineStatus = document.getElementById('lineStatus');

            let ws = null;
            let connected = false;
            let lineMode = false;

            // joystick state: normalized -1..1
            let joy = { x: 0, y: 0 };
            let sendRate = parseInt(sendRateInput.value, 10);
            let lastSend = 0;

            const PAD_RADIUS = 110; // px (half of pad size ~220)
            const KNOB_RADIUS = 40; // px
            const DEAD_PERCENT = () => parseInt(deadInput.value, 10) / 100.0; // fraction
            const MAX_INPUT = () => parseInt(maxSpeedInput.value, 10);

            function setStatus(text, ok = true) {
                statusDiv.textContent = text;
                statusDiv.style.background = ok ? '#e8f7ff' : '#ffecec';
            }

            function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

            function updateKnobFromXY(x, y) {
                const px = (x * (PAD_RADIUS - KNOB_RADIUS)) + PAD_RADIUS;
                const py = (-y * (PAD_RADIUS - KNOB_RADIUS)) + PAD_RADIUS;
                knob.style.left = px + 'px';
                knob.style.top = py + 'px';
            }

            function setJoystickFromPoint(clientX, clientY) {
                const rect = pad.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                let dx = clientX - cx;
                let dy = clientY - cy;
                let nx = clamp(dx / (rect.width / 2 - KNOB_RADIUS), -1, 1);
                let ny = clamp(-dy / (rect.height / 2 - KNOB_RADIUS), -1, 1); // invert y so up is +1
                const dz = DEAD_PERCENT();
                const mag = Math.sqrt(nx * nx + ny * ny);
                if (mag < dz) { nx = 0; ny = 0; }
                if (mag > 1) { nx /= mag; ny /= mag; }
                joy.x = nx; joy.y = ny;
                updateKnobFromXY(joy.x, joy.y);
            }

            let dragging = false;
            function startDrag(e) {
                dragging = true;
                const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
                setJoystickFromPoint(p.clientX, p.clientY);
            }
            function doDrag(e) {
                if (!dragging) return;
                e.preventDefault();
                const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
                setJoystickFromPoint(p.clientX, p.clientY);
            }
            function stopDrag() {
                dragging = false;
                joy.x = 0; joy.y = 0;
                updateKnobFromXY(0, 0);
                sendMotors(true); // force final stop
            }

            pad.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', doDrag);
            window.addEventListener('mouseup', stopDrag);
            pad.addEventListener('touchstart', startDrag, { passive: false });
            window.addEventListener('touchmove', doDrag, { passive: false });
            window.addEventListener('touchend', stopDrag);

            function mixToMotors(nx, ny) {
                let v = ny; let w = nx;
                let left = v + w;
                let right = v - w;
                const maxMag = Math.max(Math.abs(left), Math.abs(right), 1.0);
                left /= maxMag;
                right /= maxMag;
                return { left, right };
            }

            function sendMotors(force = false) {
                const now = Date.now();
                if (!force && (now - lastSend) < sendRate) return;
                lastSend = now;
                if (!connected || !ws) return;
                // If line mode is enabled, don't send joystick motor commands (optionally)
                if (lineMode) return;
                const { left, right } = mixToMotors(joy.x, joy.y);
                const maxv = MAX_INPUT();
                const lInt = Math.round(left * maxv);
                const rInt = Math.round(right * maxv);
                const msg = `${lInt},${rInt}\n`;
                ws.send(msg);
                vals.textContent = `L:${lInt}  R:${rInt}`;
            }

            // send loop using requestAnimationFrame
            function animator() {
                sendMotors();
                requestAnimationFrame(animator);
            }
            requestAnimationFrame(animator);

            // WebSocket connect / handlers
            connectBtn.addEventListener('click', () => {
                if (connected) { ws && ws.close(); return; }
                const url = wsUrlInput.value.trim();
                try {
                    ws = new WebSocket(url);
                } catch (err) {
                    setStatus('Bad URL', false);
                    return;
                }
                setStatus('connecting...');
                ws.binaryType = 'arraybuffer';
                ws.onopen = () => {
                    connected = true;
                    connectBtn.textContent = 'Disconnect';
                    setStatus('connected');
                    ws.send('HELLO\n');
                };
                ws.onclose = () => {
                    connected = false;
                    connectBtn.textContent = 'Connect';
                    setStatus('disconnected', false);
                };
                ws.onerror = (e) => {
                    setStatus('error', false);
                };
                ws.onmessage = (ev) => {
                    // Optionally show server replies (e.g., "OK" or mode ack)
                    console.debug('server:', ev.data);
                    if (typeof ev.data === 'string' && ev.data.startsWith('MODE:')) {
                        // optional: server can confirm mode changes
                    }
                };
            });

            // Line-tracing toggle button behavior
            lineToggleBtn.addEventListener('click', () => {
                if (!ws || !connected) {
                    setStatus('Connect first', false);
                    return;
                }
                lineMode = !lineMode;
                if (lineMode) {
                    lineToggleBtn.classList.add('active');
                    lineToggleBtn.textContent = 'ON';
                    lineStatus.textContent = 'mode: line-trace';
                    // tell server to enable line mode
                    ws.send('MODE:LINE:1');
                } else {
                    lineToggleBtn.classList.remove('active');
                    lineToggleBtn.textContent = 'OFF';
                    lineStatus.textContent = 'mode: manual';
                    ws.send('MODE:LINE:0');
                }
            });

            maxSpeedInput.addEventListener('input', () => { maxSpeedLbl.textContent = maxSpeedInput.value; });
            deadInput.addEventListener('input', () => { deadLbl.textContent = deadInput.value; });
            sendRateInput.addEventListener('input', () => { sendRate = parseInt(sendRateInput.value, 10); rateLbl.textContent = sendRateInput.value; });

            // init
            updateKnobFromXY(0, 0);
            setStatus('disconnected', false);
        })();
    </script>
</body>

</html>
