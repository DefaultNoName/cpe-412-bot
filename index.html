<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Robot Controller</title>
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            margin: 12px;
            background: #f6f7fb;
            color: #111
        }

        h1 {
            font-size: 18px;
            margin: 0 0 8px 0
        }

        .panel {
            background: #fff;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(10, 10, 20, 0.04);
        }

        .container {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .left {
            width: 320px;
        }

        /* control area */
        .right {
            flex: 1;
            min-width: 320px;
        }

        /* other controls */
        label {
            font-size: 13px;
            color: #555;
            display: block;
            margin-bottom: 6px;
        }

        input[type=range] {
            width: 180px;
        }

        button {
            padding: 10px 14px;
            border-radius: 8px;
            border: 0;
            background: #2b90ff;
            color: white;
            font-weight: 600;
            cursor: pointer
        }

        .status {
            font-size: 13px;
            color: #333;
            padding: 6px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-left: 8px;
            background: #f0f8ff
        }

        .small {
            font-size: 12px;
            color: #666;
        }

        .control-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }

        .four-way {
            display: grid;
            grid-template-columns: repeat(3, minmax(60px, 110px));
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .four-way .spacer {
            width: 60px;
            aspect-ratio: 1 / 1;
            background: transparent;
        }

        .arrow {
            width: 80px;
            /* desired width; change as needed */
            aspect-ratio: 1 / 1;
            /* keeps button square regardless of height */
            border-radius: 6px;
            background: #e9f2ff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            font-weight: 1000;
        }

        #btnStop.active {
            background: #ff6666;
            color: white;
        }

        .arrow.active {
            background: #2b90ff;
            color: white;
        }

        .speed-box {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
        }

        .sendrate-box {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
        }

        .arm-sliders {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
        }

        .arm-col {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
        }

        .arm-label {
            font-size: 12px;
            color: #333;
        }

        .arm-value {
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>HTML Controller</h1>

    <div class="panel container">
        <div class="left">
            <div class="panel">
                <div style="text-align:start; margin-left:68px; margin-bottom:8px;">
                    <label>Drive Control (4-way)</label>
                </div>

                <div class="four-way">
                    <div class="spacer"></div>
                    <div id="btnUp" class="arrow">⮝</div>
                    <div class="spacer"></div>

                    <div id="btnLeft" class="arrow">⮜</div>
                    <div id="btnStop" class="arrow">⬤ </div>

                    <div id="btnRight" class="arrow">⮞</div>

                    <div class="spacer"></div>
                    <div id="btnDown" class="arrow">⮟</div>
                    <div class="spacer"></div>
                </div>

                <div class="speed-box">
                    <label style="min-width:140px">Speed (0-2047): <span id="speedLbl">2047</span></label>
                    <input id="speedSlider" type="range" min="0" max="2047" step="1" value="2047">
                </div>

                <div style="margin-top:12px;" class="small">Use the arrows to command movement. Hold a button for
                    continuous movement.
                </div>
                <div id="vals" style="margin-top:12px; padding:8px; border-radius:8px; background:#f9fbff;">
                    L:0&nbsp;&nbsp;R:0&nbsp;&nbsp;Mode: MANUAL
                </div>
            </div>
        </div>

        <div class="right">
            <div class="panel">
                <div class="control-row">
                    <div style="flex:1">
                        <label>WebSocket URL</label>
                        <input id="wsUrl" type="text" value="" style="width:40%; padding:6px; box-sizing:border-box"
                            placeholder="auto: ws://&lt;device&gt;/ws" />
                        <button id="connectBtn">Connect</button>
                        <div id="status" class="status">Disconnected</div>
                    </div>

                    <div style="display:flex; flex-direction:row; align-items:flex-start;">

                    </div>
                </div>

                <div style="display:flex; gap:12px; margin-top:12px; align-items:center;">
                    <div class="speed-box">
                        <div style="flex:1">
                            <label style="min-width:120px">Send Rate (ms): <span id="sendRateLbl">80</span></label>
                            <input id="sendRate" type="range" min="40" max="500" step="10" value="80">
                        </div>
                    </div>
                </div>
                <div style="display:flex; flex-direction:row; margin-top:12px; gap:8px; align-items:flex-start;">
                    <button id="modeLineBtn">Enable Line-Tracing</button>
                    <button id="modeArmBtn">Enable Arm/Claw</button>
                </div>

                <!-- Arm sliders -->
                <div class="arm-sliders">
                    <div class="arm-col">
                        <div class="arm-label">Base<br /><span class="arm-value" id="valBase">90</span></div>
                        <input id="sBase" type="range" min="0" max="180" value="90">
                    </div>
                    <div class="arm-col">
                        <div class="arm-label">Up/Down<br /><span class="arm-value" id="valUp">90</span></div>
                        <input id="sUp" type="range" min="0" max="180" value="90">
                    </div>
                    <div class="arm-col">
                        <div class="arm-label">Back/Forth<br /><span class="arm-value" id="valBack">90</span></div>
                        <input id="sBack" type="range" min="0" max="180" value="90">
                    </div>
                    <div class="arm-col">
                        <div class="arm-label">Claw<br /><span class="arm-value" id="valClaw">90</span></div>
                        <input id="sClaw" type="range" min="0" max="180" value="90">
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        (() => {
            // UI elements
            const connectBtn = document.getElementById('connectBtn');
            const wsUrlInput = document.getElementById('wsUrl');
            const statusDiv = document.getElementById('status');
            const sendRateInput = document.getElementById('sendRate');

            const sendRateSlider = document.getElementById('sendRate');
            const sendRateLbl = document.getElementById('sendRateLbl');
            const vals = document.getElementById('vals');

            const btnUp = document.getElementById('btnUp');
            const btnDown = document.getElementById('btnDown');
            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');
            const btnStop = document.getElementById('btnStop');

            const speedSlider = document.getElementById('speedSlider');
            const speedLbl = document.getElementById('speedLbl');

            const sBase = document.getElementById('sBase');
            const sUp = document.getElementById('sUp');
            const sBack = document.getElementById('sBack');
            const sClaw = document.getElementById('sClaw');
            const valBase = document.getElementById('valBase');
            const valUp = document.getElementById('valUp');
            const valBack = document.getElementById('valBack');
            const valClaw = document.getElementById('valClaw');

            const modeLineBtn = document.getElementById('modeLineBtn');
            const modeArmBtn = document.getElementById('modeArmBtn');

            const stopBtn = document.getElementById('btnStop');

            let ws = null;
            let connected = false;
            let lineMode = false;
            let armMode = false;

            let holdTimer = null;
            let holdAction = null;
            let holdIntervalMs = 40;

            function setStatus(text, ok = true) {
                statusDiv.textContent = text;
                statusDiv.style.background = ok ? '#e8f7ff' : '#ffecec';
            }

            function sendWS(msg) {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                ws.send(msg);
            }

            // build and send left,right using 8-bit scale -255..255
            function sendLR(left, right) {
                sendWS(`${left},${right}\n`);
                vals.textContent = `L:${left}  R:${right}` + (lineMode ? '  [LINE]' : (armMode ? '  [ARM]' : ''));
            }

            // ensure hold interval syncs with sendRate UI
            function getHoldInterval() {
                const v = parseInt(document.getElementById('sendRate').value, 10);
                return (Number.isFinite(v) && v > 0) ? v : 80;
            }

            // start repeating an action while pressed
            function startHold(action) {
                // store action and current interval
                holdAction = action;
                holdIntervalMs = getHoldInterval();

                // run immediately
                try { action(); } catch (e) { console.error(e); }

                // clear existing timer just in case
                if (holdTimer) {
                    clearInterval(holdTimer);
                    holdTimer = null;
                }

                // start repeating at holdIntervalMs
                holdTimer = setInterval(() => {
                    // update interval dynamically if sendRate changed (optional)
                    const newInterval = getHoldInterval();
                    if (newInterval !== holdIntervalMs) {
                        holdIntervalMs = newInterval;
                        if (holdTimer) { clearInterval(holdTimer); holdTimer = setInterval(() => { try { holdAction(); } catch (e) { console.error(e); } }, holdIntervalMs); }
                        return;
                    }
                    try { action(); } catch (e) { console.error(e); }
                }, holdIntervalMs);
            }

            // stop repeating
            function stopHold() {
                if (holdTimer) {
                    clearInterval(holdTimer);
                    holdTimer = null;
                }
                holdAction = null;
            }

            function attachHold(elem, action) {
                if (!elem) return;

                // pointer events unify mouse/touch; fall back if not supported
                const onPress = (ev) => {
                    ev.preventDefault && ev.preventDefault();
                    elem.classList.add('active');
                    startHold(action);
                };
                const onRelease = (ev) => {
                    elem.classList.remove('active');
                    stopHold();
                };

                // Modern: pointer events (best)
                if (window.PointerEvent) {
                    elem.addEventListener('pointerdown', onPress);
                    window.addEventListener('pointerup', onRelease);
                    window.addEventListener('pointercancel', onRelease);
                    // also stop on pointerleave so releasing outside stops repeat
                    elem.addEventListener('pointerleave', (e) => {
                        // if pointer is pressed and leaves element, stop the hold
                        if (e.pressure > 0 || e.buttons) onRelease(e);
                    });
                } else {
                    // Fallback: mouse + touch
                    elem.addEventListener('mousedown', onPress);
                    window.addEventListener('mouseup', onRelease);
                    elem.addEventListener('touchstart', onPress, { passive: false });
                    window.addEventListener('touchend', onRelease);
                    window.addEventListener('touchcancel', onRelease);
                }

                // keyboard accessibility: space/enter to trigger a single press (and hold behavior if keydown)
                elem.addEventListener('keydown', (e) => {
                    if (e.key === ' ' || e.key === 'Enter') {
                        elem.classList.add('active');
                        startHold(action);
                    }
                });
                elem.addEventListener('keyup', (e) => {
                    if (e.key === ' ' || e.key === 'Enter') {
                        elem.classList.remove('active');
                        stopHold();
                    }
                });
            }

            // attach press/release events for buttons (mouse + touch)
            function attachHold(el, action) {
                el.addEventListener('mousedown', (e) => { e.preventDefault(); el.classList.add('active'); startHold(action); });
                window.addEventListener('mouseup', () => { el.classList.remove('active'); stopHold(); });
                el.addEventListener('touchstart', (e) => { e.preventDefault(); el.classList.add('active'); startHold(action); }, { passive: false });
                window.addEventListener('touchend', () => { el.classList.remove('active'); stopHold(); });
                // click fallback
                el.addEventListener('click', () => { action(); });
            }

            attachHold(btnUp, () => driveForward(parseInt(speedSlider.value, 10)));
            attachHold(btnDown, () => driveBack(parseInt(speedSlider.value, 10)));
            attachHold(btnLeft, () => turnLeft(parseInt(speedSlider.value, 10)));
            attachHold(btnRight, () => turnRight(parseInt(speedSlider.value, 10)));
            attachHold(btnStop, () => stopMotors());

            // speed UI
            if (speedSlider && speedLbl) speedLbl.textContent = speedSlider.value;
            speedSlider.addEventListener('input', () => {
                speedLbl.textContent = speedSlider.value;
            });

            // initialize label with current slider value on load
            if (sendRateLbl && sendRateInput) sendRateLbl.textContent = sendRateInput.value;

            // Update label when slider changes and update holdInterval immediately
            sendRateInput.addEventListener('input', () => {
                if (sendRateLbl) sendRateLbl.textContent = sendRateInput.value;
                // update holdInterval used by startHold (so hold uses the new rate immediately)
                holdInterval = parseInt(sendRateInput.value, 10) || 80;
            });


            // connect WS
            connectBtn.addEventListener('click', () => {
                if (connected) { ws.close(); return; }
                const host = wsUrlInput.value.trim() || `ws://${location.hostname}/ws`;
                try { ws = new WebSocket(host); } catch (e) { setStatus('Bad URL', false); return; }
                setStatus('Connecting...');
                ws.onopen = () => { connected = true; connectBtn.textContent = 'Disconnect'; setStatus('Connected'); ws.send('HELLO\n'); };
                ws.onclose = () => { connected = false; connectBtn.textContent = 'Connect'; setStatus('Disconnected', false); };
                ws.onerror = (e) => { setStatus('error', false); };
                ws.onmessage = (ev) => {
                    const txt = (typeof ev.data === 'string') ? ev.data : '';
                    if (txt.startsWith('MODE:LINE:1') || txt.startsWith('MODE:LINE:OK')) {
                        lineMode = true; modeLineBtn.textContent = 'Disable Line-Tracing';
                    } else if (txt.startsWith('MODE:LINE:0') || txt.startsWith('MODE:MANUAL:OK')) {
                        lineMode = false; modeLineBtn.textContent = 'Enable Line-Tracing';
                    } else if (txt.startsWith('MODE:ARM:1') || txt.startsWith('MODE:ARM:OK')) {
                        armMode = true; modeArmBtn.textContent = 'Disable Arm';
                    } else if (txt.startsWith('MODE:ARM:0') || txt.startsWith('MODE:ARM:OFF')) {
                        armMode = false; modeArmBtn.textContent = 'Enable Arm';
                    }
                };
            });

            // Line and Arm toggles
            modeLineBtn.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) { alert('Open WebSocket first'); return; }
                lineMode = !lineMode;
                modeLineBtn.textContent = lineMode ? 'Disable Line-Tracing' : 'Enable Line-Tracing';
                const msg = lineMode ? 'MODE:LINE:1' : 'MODE:LINE:0';
                sendWS(msg);
                setStatus('sent ' + msg);
            });

            modeArmBtn.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) { alert('Open WebSocket first'); return; }
                armMode = !armMode;
                modeArmBtn.textContent = armMode ? 'Disable Arm' : 'Enable Arm';
                const msg = armMode ? 'MODE:ARM:1' : 'MODE:ARM:0';
                sendWS(msg);
                setStatus('sent ' + msg);
                // immediate send of arm sliders when enabling
                if (armMode) {
                    const b = parseInt(sBase.value, 10), u = parseInt(sUp.value, 10), bk = parseInt(sBack.value, 10), c = parseInt(sClaw.value, 10);
                    sendWS(`ARM:${b},${u},${bk},${c}\n`);
                }
            });

            // Arm sliders: send immediately when changed (if arm mode enabled)
            [sBase, sUp, sBack, sClaw].forEach(el => {
                el.addEventListener('input', () => {
                    valBase.textContent = sBase.value; valUp.textContent = sUp.value;
                    valBack.textContent = sBack.value; valClaw.textContent = sClaw.value;
                    if (armMode && ws && ws.readyState === WebSocket.OPEN) {
                        const b = parseInt(sBase.value, 10), u = parseInt(sUp.value, 10), bk = parseInt(sBack.value, 10), c = parseInt(sClaw.value, 10);
                        sendWS(`ARM:${b},${u},${bk},${c}\n`);
                    }
                });
            });



            setStatus('Disconnected', false);
        })();
    </script>
</body>

</html>
